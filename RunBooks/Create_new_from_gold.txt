# Source Contol for this object is located in https://dev.azure.com/cooporg/CO-OP%20Financial%20Services/_git/Platform-AzureVirtualDesktop?path=/&version=GBaa-avd-image-automation-001
# Authenticating
Write-Output "Logging in as automation's account system assigned Managed Identy"

try

{
    "Connecting in to Azure..."
    Connect-AzAccount -Identity
}
catch {
    Write-Error -Message $_.Exception
    throw $_.Exception
}

#Template Spec ID
$id = "/subscriptions/b9045cb2-6581-49b4-a1a5-cf48e88bc119/resourceGroups/rg-image-automation-001/providers/Microsoft.Resources/templateSpecs/New_VM_From_Windows_11_Gold/versions/1.0"

#Something to make each machine "special"
# Get the current time in local time zone
$dateofcreate = Get-Date -Format "MM-dd"

Write-Output "A new host will be created as $dateofcreate in the rg-avd-build-001 RG"
Write-Output "Nothing will be displayed here till it completes. Go look in the RG"

New-AzResourceGroupDeployment -TemplateSpecID $id -ResourceGroupName rg-avd-build-001 -networkInterfaceName "$dateofcreate-patch" -virtualMachineName "$dateofcreate-patch" -virtualMachineComputerName "$dateofcreate-patch"

Write-Output 'Disconnecting AZ Session'
$DisconnectInfo = Disconnect-AzAccount
Write-Output 'End of Job'